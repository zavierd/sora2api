# Sora2API 服务器部署配置
#
# 此配置用于在已有 CLIProxyAPI 的服务器上部署 Sora2API
# 连接到 CLIProxyAPI 的现有网络 (new-api_default)
#
# 使用方法:
#   cd /root/sora2api
#   docker-compose -f docker-compose.server.yml up -d
#
# 环境变量:
#   SORA2API_ADMIN_USER - 管理员用户名 (默认: admin)
#   SORA2API_ADMIN_PASS - 管理员密码 (默认: admin)
#   SYNC_INTERVAL - 同步间隔秒数 (默认: 3600)

services:
  # Sora2API 主服务
  sora2api:
    build:
      context: .
      dockerfile: Dockerfile
    image: sora2api:latest
    container_name: sora2api
    environment:
      - TZ=Asia/Shanghai
    ports:
      # 只绑定本地，外网通过 new-api 访问
      - "127.0.0.1:8385:8385"
    volumes:
      # 配置文件
      - ./config/setting.toml:/app/config/setting.toml
      # 数据持久化
      - ./data:/app/data
      # 缓存目录
      - ./cache:/app/cache
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8385/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - new-api_default

  # 账号同步服务 (定时从 gpt_team MySQL 同步原始 ChatGPT 账号)
  sora-sync:
    build:
      context: .
      dockerfile: Dockerfile
    image: sora2api:latest
    container_name: sora-sync
    entrypoint: ["sh", "-c"]
    command:
      - |
        echo "========================================"
        echo " Sora2API Account Sync Service"
        echo " Data Source: gpt_team MySQL"
        echo "========================================"
        echo "MYSQL_HOST: $${GPT_TEAM_MYSQL_HOST:-mysql}"
        echo "MYSQL_DATABASE: $${GPT_TEAM_MYSQL_DATABASE:-gpt_team}"
        echo "SORA2API_URL: http://sora2api:8385"
        echo "SYNC_INTERVAL: $${SYNC_INTERVAL:-3600}s"
        echo "========================================"
        
        # 等待 sora2api 启动
        echo "Waiting for sora2api to start..."
        sleep 30
        
        # 首次同步
        echo "=== Initial sync at $$(date) ==="
        python3 /app/scripts/sync_from_gpt_team.py \
          --mysql-host $${GPT_TEAM_MYSQL_HOST:-mysql} \
          --mysql-port $${GPT_TEAM_MYSQL_PORT:-3306} \
          --mysql-user $${GPT_TEAM_MYSQL_USER:-root} \
          --mysql-pass "$${GPT_TEAM_MYSQL_PASSWORD:-Gemini2024!}" \
          --mysql-db $${GPT_TEAM_MYSQL_DATABASE:-gpt_team} \
          --sora-url http://sora2api:8385 \
          --sora-user $${SORA2API_ADMIN_USER:-admin} \
          --sora-pass $${SORA2API_ADMIN_PASS:-admin} \
          -v || echo "Initial sync failed, will retry..."
        
        # 定时同步循环
        while true; do
          echo "Sleeping $${SYNC_INTERVAL:-3600}s until next sync..."
          sleep $${SYNC_INTERVAL:-3600}
          echo "=== Sync at $$(date) ==="
          python3 /app/scripts/sync_from_gpt_team.py \
            --mysql-host $${GPT_TEAM_MYSQL_HOST:-mysql} \
            --mysql-port $${GPT_TEAM_MYSQL_PORT:-3306} \
            --mysql-user $${GPT_TEAM_MYSQL_USER:-root} \
            --mysql-pass "$${GPT_TEAM_MYSQL_PASSWORD:-Gemini2024!}" \
            --mysql-db $${GPT_TEAM_MYSQL_DATABASE:-gpt_team} \
            --sora-url http://sora2api:8385 \
            --sora-user $${SORA2API_ADMIN_USER:-admin} \
            --sora-pass $${SORA2API_ADMIN_PASS:-admin} \
            -v
        done
    environment:
      - TZ=Asia/Shanghai
      - SYNC_INTERVAL=${SYNC_INTERVAL:-3600}
      - SORA2API_ADMIN_USER=${SORA2API_ADMIN_USER:-admin}
      - SORA2API_ADMIN_PASS=${SORA2API_ADMIN_PASS:-admin}
      # MySQL 配置 (gpt_team 数据库)
      - GPT_TEAM_MYSQL_HOST=${GPT_TEAM_MYSQL_HOST:-mysql}
      - GPT_TEAM_MYSQL_PORT=${GPT_TEAM_MYSQL_PORT:-3306}
      - GPT_TEAM_MYSQL_USER=${GPT_TEAM_MYSQL_USER:-root}
      - GPT_TEAM_MYSQL_PASSWORD=${GPT_TEAM_MYSQL_PASSWORD:-Gemini2024!}
      - GPT_TEAM_MYSQL_DATABASE=${GPT_TEAM_MYSQL_DATABASE:-gpt_team}
    volumes:
      - ./scripts:/app/scripts:ro
    depends_on:
      sora2api:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - new-api_default

  # Sora2API 代理服务 (供 CPAMC 前端访问)
  sora-proxy:
    image: nginx:alpine
    container_name: sora-proxy
    ports:
      - "8386:80"
    volumes:
      - ./nginx-proxy.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - sora2api
    restart: unless-stopped
    networks:
      - new-api_default

networks:
  new-api_default:
    external: true
