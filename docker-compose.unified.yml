# CLIProxyAPI + Sora2API 统一部署配置
#
# 使用方法:
#   docker-compose -f docker-compose.unified.yml up -d
#
# 此配置将 CLIProxyAPI 和 Sora2API 部署在同一网络中
# 支持账号同步功能

services:
  # Sora2API 服务
  sora2api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sora2api
    environment:
      - TZ=Asia/Shanghai
    ports:
      - "8000:8000"
    volumes:
      # 配置文件
      - ./config/setting.toml:/app/config/setting.toml
      # 数据持久化
      - sora2api_data:/app/data
      # 挂载 CLIProxyAPI 认证目录用于同步
      - ${CLIPROXY_AUTH_PATH:-../CLIProxyAPI/auths}:/cliproxy_auths:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - unified_network

  # 账号同步定时任务
  sora-sync:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sora-sync
    entrypoint: ["sh", "-c"]
    command:
      - |
        echo "Sora Sync Service Started"
        # 等待 sora2api 启动
        sleep 30
        while true; do
          echo "=== Starting sync at $$(date) ==="
          python3 /app/scripts/sync_from_cliproxy.py \
            --auth-dir /cliproxy_auths \
            --sora-url http://sora2api:8000 \
            --sora-user $${SORA2API_ADMIN_USER:-admin} \
            --sora-pass $${SORA2API_ADMIN_PASS:-admin} \
            -v
          echo "=== Sync completed, sleeping $${SYNC_INTERVAL:-3600}s ==="
          sleep $${SYNC_INTERVAL:-3600}
        done
    environment:
      - TZ=Asia/Shanghai
      - SYNC_INTERVAL=${SYNC_INTERVAL:-3600}  # 默认1小时同步一次
      - SORA2API_ADMIN_USER=${SORA2API_ADMIN_USER:-admin}
      - SORA2API_ADMIN_PASS=${SORA2API_ADMIN_PASS:-admin}
      - CODEX_CLIENT_ID=${CODEX_CLIENT_ID:-app_EMoamEEZ73f0CkXaXp7hrann}
    volumes:
      - ${CLIPROXY_AUTH_PATH:-../CLIProxyAPI/auths}:/cliproxy_auths:ro
      - ./scripts:/app/scripts:ro
    depends_on:
      - sora2api
    restart: unless-stopped
    networks:
      - unified_network

networks:
  unified_network:
    name: cliproxy_sora_network
    driver: bridge

volumes:
  sora2api_data:
